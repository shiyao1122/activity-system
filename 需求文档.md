# 活动积分管理系统 - 需求与技术说明文档

## 第一部分：业务需求文档 (PRD)

### 1\. 项目背景

为了统一管理 HitPaw 旗下多端产品（Web, App, PC）的营销活动，需要建立一个轻量级的积分结算中台。该系统负责记录任务进度、统计用户积分、管理活动配置，并为人工兑奖提供数据支持。

### 2\. 核心功能模块

#### 2.1 活动与任务管理 (Admin)

* **活动配置**：支持创建多个活动，定义开始与结束时间。
* **任务定义**：

* 任务分组（如：注册登录、社交关注、每日互动等）。
* 积分分值设置。
* **频率限制**：支持设置“每日完成上限”和“活动期间总完成上限”。
* **多语言支持**：支持根据 lang 参数下发对应语言的任务描述。
* **状态维护**：支持管理员手动修改用户的积分或任务状态（调账）。

#### 2.2 积分记录逻辑 (System)

* **任务上报**：接收业务端指令，验证频率限制后记录积分。
* **邀请机制**：

* 当新用户 B 完成“注册任务”时，若上报了邀请人 A 的标识，系统需自动为 A 记录“邀请任务”积分。
* 需维护 A 与 B 的邀请绑定关系。
* **防刷机制**：通过接口层面的频率限制和数据库层面的次数校验，防止超额发分。

#### 2.3 数据看板 (Dashboard)

* **活动概览**：参与总人数、已发放总积分。
* **排行榜**：基于活动维度的用户积分排名 Top 100。
* **明细查询**：按 Email 查询用户的任务完成时间轴和分值明细。

### 3\. 业务规则

* **用户识别**：全平台统一使用 Email 作为唯一用户标识。
* **积分用途**：积分仅作为数值汇总，活动结束后由人工导出数据进行奖励发放。
* **多语言下发**：系统预设任务描述的 JSON 字典，根据请求参数返回对应文本。

---

## 第二部分：技术架构文档 (TDD)

### 1\. 技术选型

* **管理后台前端**：Vue 3 + Vite + Element Plus (构建响应式后台)。
* **服务端**：Node.js (Express 或 Fastify)。
* **数据库**：PostgreSQL (利用 JSONB 存储多语言数据)。
* **ORM 框架**：Prisma (提升开发效率与类型安全)。
* **部署环境**：Render.com (托管 Web Service 与 PostgreSQL)。

### 2\. 数据库建模 (Prisma Schema)

codePrisma

```
// 活动表
model Activity {
  id          Int      @id @default(autoincrement())
  name        String
  startTime   DateTime
  endTime     DateTime
  status      String   // DRAFT, ACTIVE, ENDED
  tasks       Task[]
  userActs    UserActivity[]
}
// 任务配置表
model Task {
  id          Int      @id @default(autoincrement())
  activityId  Int
  groupName   String   // 任务组: 1.注册/登录
  points      Int
  dailyLimit  Int      @default(1) // 0 为不限
  totalLimit  Int      @default(0) // 0 为不限
  descJson    Json     // 格式: {"en": "Follow Twitter", "zh": "关注推特"}
  activity    Activity @relation(fields: [activityId], references: [id])
  logs        TaskLog[]
}
// 用户活动汇总表
model UserActivity {
  id          Int      @id @default(autoincrement())
  email       String
  activityId  Int
  totalPoints Int      @default(0)
  updatedAt   DateTime @updatedAt
  activity    Activity @relation(fields: [activityId], references: [id])
  logs        TaskLog[]
  @@unique([email, activityId])
}
// 任务完成明细表
model TaskLog {
  id             Int          @id @default(autoincrement())
  userActivityId Int
  taskId         Int
  pointsEarned   Int
  createdAt      DateTime     @default(now())
  userActivity   UserActivity @relation(fields: [userActivityId], references: [id])
  task           Task         @relation(fields: [taskId], references: [id])
}
// 邀请关系表
model UserRelation {
  id           Int      @id @default(autoincrement())
  inviterEmail String
  inviteeEmail String
  activityId   Int
  createdAt    DateTime @default(now())
}
```

### 3\. 关键 API 接口设计

#### 3.1 客户端/业务端接口 (Client API)

* **POST /api/v1/task/report**

* **功能**：上报任务完成情况。
* **核心逻辑**：使用 DB 事务。校验任务次数上限 -> 插入 TaskLog -> 更新 UserActivity 总分 -> (可选) 触发邀请人加分。
* **GET /api/v1/user/status**

* **功能**：获取用户当前活动进度和总积分。
* **参数**：email, activity\_id, lang。

#### 3.2 管理端接口 (Admin API)

* **GET /api/admin/stats/:activityId**：获取看板统计数据。
* **POST /api/admin/task/adjust**：人工干预接口，手动增减用户积分。
* **GET /api/admin/export/rank**：导出积分排名 CSV。

### 4\. 部署与安全配置 (Render)

* **环境变量**：

* DATABASE\_URL: Render PostgreSQL 连接字符串。
* API\_SECRET\_KEY: 用于业务端调用时的鉴权 Token，防止非法刷分。
* **静态部署**：Vue 前端编译为静态资源后部署在 Render Static Site，通过 API Proxy 与后端通信。
* **时区处理**：服务器统一采用 UTC 时间，前端展示及“每日上限”计算逻辑固定使用 UTC+8。

---

### 5\. 开发建议（针对分析师视角）

1. **幂等性**：在 report 接口增加请求去重逻辑，防止因前端快速点击导致的重复计分。
2. **扩展性**：descJson 字段预留 icon 或 link 键值对，以便未来前端展示需要。
3. **日志**：记录所有管理后台的“调账”操作，防止内部误操作。